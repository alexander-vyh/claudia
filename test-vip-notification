#!/usr/bin/env node
/**
 * Test VIP Email Notification with Interactive Buttons
 * Sends a sample notification to test the button interactions
 */

const https = require('https');
const { execSync } = require('child_process');
const config = require('./lib/config');

const CONFIG = {
  slackToken: config.slackBotToken,
  mySlackUserId: config.slackUserId,
  gmailAccount: config.gmailAccount
};

/**
 * Get a real unread email ID for testing
 */
function getRealEmailId() {
  try {
    const result = execSync(
      `gog gmail messages search "is:unread" --account ${CONFIG.gmailAccount} --max 1 --json`,
      { encoding: 'utf-8', stdio: ['pipe', 'pipe', 'ignore'] }
    );
    const data = JSON.parse(result);
    return data.messages?.[0]?.id || null;
  } catch (error) {
    return null;
  }
}

/**
 * Create Block Kit blocks for test VIP email
 */
function createTestEmailBlocks(emailId) {
  return [
    {
      type: "section",
      text: {
        type: "mrkdwn",
        text: `ğŸ”´ *URGENT EMAIL* _(Test Notification)_\n*From:* Test Sender <test@example.com>\n*Subject:* Test VIP Email - Interactive Buttons Demo\n*Reason:* â­ VIP sender\n*Time:* ${new Date().toISOString()}`
      }
    },
    {
      type: "actions",
      elements: [
        {
          type: "button",
          text: { type: "plain_text", text: "ğŸ“§ View" },
          action_id: "view_email_modal",
          value: emailId,
          style: "primary"
        },
        {
          type: "button",
          text: { type: "plain_text", text: "ğŸŒ Gmail" },
          action_id: "open_in_gmail",
          value: emailId,
          url: `https://mail.google.com/mail/u/0/#inbox/${emailId}`
        },
        {
          type: "button",
          text: { type: "plain_text", text: "âœ“ Archive" },
          action_id: "archive_email",
          value: emailId
        },
        {
          type: "button",
          text: { type: "plain_text", text: "ğŸ—‘ï¸ Trash" },
          action_id: "delete_email",
          value: emailId,
          style: "danger"
        },
        {
          type: "button",
          text: { type: "plain_text", text: "Unsubscribe" },
          action_id: "unsubscribe_email",
          value: emailId
        }
      ]
    },
    {
      type: "context",
      elements: [
        {
          type: "mrkdwn",
          text: "ğŸ’¡ _This is a test notification. Click the buttons to test the interactive features!_"
        }
      ]
    }
  ];
}

/**
 * Send Slack message
 */
function sendSlackMessage(channel, text, blocks) {
  return new Promise((resolve, reject) => {
    const data = JSON.stringify({
      channel,
      text,
      blocks,
      unfurl_links: false
    });

    const options = {
      hostname: 'slack.com',
      path: '/api/chat.postMessage',
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${CONFIG.slackToken}`,
        'Content-Type': 'application/json',
        'Content-Length': Buffer.byteLength(data)
      }
    };

    const req = https.request(options, (res) => {
      let body = '';
      res.on('data', chunk => body += chunk);
      res.on('end', () => {
        try {
          const response = JSON.parse(body);
          if (response.ok) {
            resolve(response);
          } else {
            reject(new Error(`Slack error: ${response.error}`));
          }
        } catch (e) {
          reject(e);
        }
      });
    });

    req.on('error', reject);
    req.write(data);
    req.end();
  });
}

/**
 * Main
 */
async function main() {
  console.log('\nğŸ§ª Testing VIP Email Notification with Interactive Buttons\n');

  // Get a real email ID from inbox
  console.log('ğŸ“§ Finding a real email for testing...');
  const emailId = getRealEmailId();

  if (!emailId) {
    console.error('âœ— No unread emails found. Please send yourself a test email first.');
    process.exit(1);
  }

  console.log(`âœ“ Using email ID: ${emailId}\n`);

  // Create test notification blocks
  const blocks = createTestEmailBlocks(emailId);

  // Send test notification
  console.log('ğŸ“¨ Sending test VIP notification to Slack...');
  try {
    await sendSlackMessage(
      CONFIG.mySlackUserId,
      'ğŸ”´ TEST: VIP Email Notification',
      blocks
    );
    console.log('âœ“ Test notification sent!\n');
    console.log('Check your Slack DMs and try clicking the buttons:\n');
    console.log('  ğŸ“§ View Full - Gets full email content');
    console.log('  ğŸŒ Open Gmail - Opens email in browser');
    console.log('  ğŸ“¦ Archive - Archives the email');
    console.log('  ğŸ—‘ï¸ Delete - Moves to trash');
    console.log('  ğŸš« Unsubscribe - Runs automated unsubscribe\n');
  } catch (error) {
    console.error('âœ— Failed to send test notification:', error.message);
    process.exit(1);
  }
}

main();
